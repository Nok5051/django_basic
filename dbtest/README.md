# DB 연동 (model)

> dbtest 프로젝트



### SQLite

https://www.sqlite.org/download.html



밑에서 **Precompiled Binaries for Windows**  해당 메뉴 찾기

[sqlite-tools-win32-x86-3380500.zip](https://www.sqlite.org/2022/sqlite-tools-win32-x86-3380500.zip) (1.87 MiB)  다운



```terminal
C:\worksplaces\workspace_django 경로 수정

>django-admin startproject dbtest
```



**SQLite.exe 파일경로 (해당 위치로 옮겨야함)**
C:\worksplaces\workspace_django\dbtest

```terminal
>cd dbtest
>sqlite3

sqlite> 해당 꺽쇠나오는지 확인
```



**장고에 SQLite db 연결**

```terminal
>python manage.py runserver

## < 해당 경고문이 나오는지 확인 > ##
You have 18 unapplied migration(s). Your project may not work properly until you apply the migrations for app(s): admin, auth, contenttypes, sessions.
Run 'python manage.py migrate' to apply them.
June 17, 2022 - 09:18:22
Django version 4.0.5, using settings 'dbtest.settings'


>python manage.py migrate
```



### 알고가자!

- view : 데이터를 처리해줌
- template : html로 렌더링
- model : database 연동 
  (ORM : 객체와 관계를 연결 즉, view와 DB를 연결해주는 파일)



 **dbtest 앱에서 setting.py**

C:\worksplaces\workspace_django\dbtest\setting.py
https://docs.djangoproject.com/en/4.0/ref/settings/#databases 링크 참고

```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}

# 해당 내용을 찾아서 sqlite3 로 설정해 줍니다.
```

- 왼쪽 도구창에서 dbtest(프로젝트)/db.sqlite3 파일 만들어졌는지 확인



**db.sqlite3 들어가기**

```terminal
>sqlite3 db.sqlite3 
```



앱과 관련된 테이블이 잘 만들어졌는지 확인

```sqlite
.table 
```



dbtest 앱의 settings.py 에 내용 수정 

```python
# 해당 내용 찾아서 
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'dbtest', #<--- 해당 내용 추가! 
]
```



**models.py 생성**

- 경로 dbtest/dbtest/models.py

내용 추가 

```python
from django.db import models

class MyBoard(models.Model):
    myname = models.CharField(max_length=100)
    mytitle = models.CharField(max_length=500)
    mycontent = models.CharField(max_length=2000)
    mydate = models.DateTimeField()
```

class로 정의된 MyBoard 는 테이블로 형성이되고 
변수는 칼럼으로 정의된다.



**터미널로 나가서 migration 추가** 

```terminal
sqlite> .exit #sqlite를 나가줍니다.

#terminal에서 실행 (경로 C:\worksplaces\workspace_django\dbtest)
>python manage.py makemigrations dbtest
```



생성 확인

- 경로 dbtest/dbtest/migrations/0001_initial.py 파일 

  ```python
  # Generated by Django 4.0.5 on 2022-06-17 00:49
  
  from django.db import migrations, models
  
  
  class Migration(migrations.Migration):
  
      initial = True
  
      dependencies = [
      ]
  
      operations = [
          migrations.CreateModel(
              name='MyBoard',
              fields=[
                  ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                  ('myname', models.CharField(max_length=100)),
                  ('mytitle', models.CharField(max_length=500)),
                  ('mycontent', models.CharField(max_length=2000)),
                  ('mydate', models.DateTimeField()),
              ],
          ),
      ]
  ```

- 해당 내용으로 파일이 잘 생성되었는지 확인
- primary 키가 있는 칼럼을 따로 지정하지 않으면 primary 키 특성을 가진 id를 자동으로 생성해줌



**DB 적용** (initial 파일에 있는 내용을 DB에 전달)

```terminal
>python manage.py migrate #db 적용

# 해당 내용 잘 나오는 지 확인 
Operations to perform:
  Apply all migrations: admin, auth, contenttypes, dbtest, sessions
Running migrations:
  Applying dbtest.0001_initial... OK  ## 특히 이부분 0001_initial
  
#db 접속
>sqlite3 db.sqlite3 
```



**테이블 확인** 

- sqlite3> 

```sqlite
.table

.schema dbtest_myboard

.exit
```

CREATE TABLE IF NOT EXISTS "dbtest_myboard" ("id" integer NOT NULL PRIMARY KEY AUTOINCREMENT, "myname" varchar(100) NOT NULL, "mytitle" varchar(500) NOT NULL, "mycon
tent" varchar(2000) NOT NULL, "mydate" datetime NOT NULL); 

- 내용 잘 나오는 지 확인 



**파이썬 창 실행** 

```terminal
>python manage.py shell

# 파이썬 쉘(repl)이 떠야함
>>> 
```

- repl (interective shell) 
  - read, eval, print, loop



그대로 파이썬 실행

```terminal
>>> from dbtest.models import MyBoard
>>> from django.utils import timezone
>>> test = MyBoard(myname='testuser', mytitle='test title',mycontent='test 1234 abcd',mydate=timezone.now()) 
>>> test.save() 
```

- 데이터베이스에 insert 가 완료됨 
- 나가준다.

```terminal
>>> exit()
```



**template**

- dbtest/dbtest/template 폴더 생성
- dbtest/dbtest/template /index.html 파일 생성 및 내용 추가 

```html
<body>

    <h1>Hello, Django (with sqlite3)</h1>

    <table border="1">
        <col width="50">
        <col width="100">
        <col width="500">
        <col width="100">

        <tr>
            <th>번호</th>
            <th>작성자</th>
            <th>제목</th>
            <th>작성일</th>
        </tr>

        {% if not list %}
            <tr>
                <th>-----------작성된 글이 없습니다-----------</th>
            </tr>
        {% else %}
            {% for data in list %}
                <tr>
                    <td>{{ data.id }}</td>
                    <td>{{ data.myname }}</td>
                    <td><a href="#">{{ data.mytitle }}</a></td> <!--밑에서 내용이 추가됩니다 -->
                    <td>{{ data.mydate }}</td>
                </tr>
            {% endfor %}
        {% endif %}
        <tr>
            <td colspan="4" align="right">
                <input type="button" value="글작성" onclick="">
            </td>
        </tr>

    </table>

</body>
```



**views.py**

- dbtest/dbtest/veiws.py 생성 및 내용 추가 

```python
from django.shortcuts import render
from .models import MyBoard

def index(request):
    # object : django.db.models.Manager 객체
    myboard = MyBoard.objects.all()
    return render(request, 'index.html', {'list': myboard})
```

- myboard = MyBoard.objects.all()
  - MODEL(models.py)과 데이터베이스의 연결해주는 MANAGERS (objects) 임
  - 즉, objects.all 은 데이터베이스에 select * from MyBoard 메세지를 보내는 것과 같다.



**urls.py**

- dbtest/dbtest/urls.py 찾아서 내용 수정

```python
from django.contrib import admin
from django.urls import path
from . import views ## 내용 추가 


urlpatterns = [
    path('admin/', admin.site.urls),
    path('', views.index) ## 내용 추가
]
```



**서버 실행**

```terminal
>python manage.py runserver
```

- 테이블이 잘 생성되었는지 확인



detail.html

- templates/detail.html

```python
<body>

    <h1>Detail</h1>

    <table border="1">
        <tr>
            <th>작성자</th>
            <td><input type="text" value="{{ dto.myname }}" readonly></td>
        </tr>
        <tr>
            <th>제목</th>
            <td><input type="text" value="{{ dto.mytitle }}" readonly></td>
        </tr>
        <tr>
            <th>내용</th>
            <td><textarea cols="60" rows="10" readonly>{{ dto.mycontent }}</textarea></td>
        </tr>
        <tr>
            <td colspan="2" align="right">
                <input type="button" onclick="" value="목록">
                <input type="button" onclick="" value="수정">
                <input type="button" onclick="" value="삭제">
            </td>
        </tr>
    </table>

</body>
```



views.py 내용 수정

```python
## 맨 밑에 내용 추가 

def detail(request, id):
    return render(request, 'detail.html', {'dto': MyBoard.objects.get(id=id)})
```

- 



urls.py 내용 수정 

```python
urlpatterns = [
    path('admin/', admin.site.urls),
    path('', views.index),
    path('detail/<int:id>', views.detail), ## 내용 추가 
]
```

- 'detail/<int:id>' 
  - detail 에서 전달되는 값은 id이고 int 다 



template

- dbtest/dbtest/template /index.html 내용 수정

```html
{% for data in list %}
	<tr>
		<td>{{ data.id }}</td>
		<td>{{ data.myname }}</td>
		<td><a href="detail/{{ data.id }}">{{ data.mytitle }}</a></td> 
        <!--  -->
		<td>{{ data.mydate }}</td>
	</tr>
{% endfor %}
```



insert.html

- templates/insert.html 생성 
- post 방식에 대한 이해
  - https://noahlogs.tistory.com/35

```html
<body>

    <h1>Insert</h1>
    <form action="" method="post">{% csrf_token %} <!-- post 방식일 떄 꼭 써줘야함-->
        <table border="1">
            <tr>
                <th>작성자</th>
                <td><input type="text" name="myname"></td> <!-- -->
            </tr>
            <tr>
                <th>제목</th>
                <td><input type="text" name="mytitle"></td>
            </tr>
            <tr>
                <th>내용</th>
                <td><textarea cols="60" rows="10" name="mycontent"></textarea></td>
            </tr>
            <tr>
                <td>
                    <input type="button" value="취소" onclick="">
                    <input type="submit" value="글작성">
                </td>
            </tr>
        </table>

    </form>


</body>
```



views.py

- dbtest/views.py 맨 밑에 내용 추가 

```python
def insert_form(request):
    return render(request, 'insert.html')

def insert_proc(request):
    myname = request.POST['myname']
    mytitle = request.POST['mytitle']
    mycontent = request.POST['mycontent']
    result = MyBoard.objects.create(myname=myname, mytitle=mytitle, mycontent=mycontent, mydate=timezone.now())

    if result:
        redirect('index')
    else:
        return redirect('insertform')
	
```

- result 변수에서  creat 공부하기 



urls.py

- dbtest/urls.py 내용 수정 및 추가

```python
urlpatterns = [
    path('admin/', admin.site.urls),
    path('', views.index, name='index'), #내용 수정
    path('detail/<int:id>', views.detail, name='detail'), # 내용수정
    path('insertform/', views.insert_form, name='insertform'),# 내용추가
    path('insertres/', views.insert_proc),  # 내용추가
]
```



index.html

- templates/index.html 내용 수정 및 추가

```html
{% for data in list %}
	<tr>
		<td>{{ data.id }}</td>
		<td>{{ data.myname }}</td>
		<td><a href="{% url 'detail' data.id %}">{{ data.mytitle }}</a></td> <!--내용 수정-->
		<td>{{ data.mydate }}</td>
	</tr>
{% endfor %}
```



insertform 버튼 활성화 

- index.html   (templates/index.html) 내용 수정 

```html
<tr>
	<td colspan="4" align="right">
		<input type="button" value="글작성" onclick="lacation.href='insertform/'"> 
        <!--onclick 내용 수정-->
	</td>
</tr>
```

- 글작성 누르면 폼이 잘 뜨는지 확인



insert.html 

```html
<form action="./insertres/" method="post">{% csrf_token %}  
    <!-- action 에 내용 추가 -->
```



글작성 서버에서 작동되는지 확인

```terminal
python manage.py runserver
```



------

**업데이트 기능 활성화**



update.html 

- templates/update.html

```html
<body>

    <h1>Update</h1>
    <form action="" method="post">{% csrf_token %}
        <input type="hidden" name="id" value="{{ dto. id }}">
        <table border="1">
            <tr>
                <th>작성자</th>
                <td><input type="text" value="{{ dto.myname }}" readonly></td>
            </tr>
            <tr>
                <th>제목</th>
                <td><input type="text" value="{{ dto.mytitle }}" name="mytitle"></td>
            </tr>
            <tr>
                <th>내용</th>
                <td><textarea cols="60" rows="10" name="mycontent">{{ dto.mycontent }}</textarea></td>
            </tr>
            <tr>
                <td colspan="2" align="right">
                    <input type="button" value="취소" onclick="">
                    <input type="submit" value="글수정">
                </td>
            </tr>

        </table>

    </form>

</body>
```

<input type="hidden" name="id" value="{{ dto. id }}">
누구를 수정할 건지 정해주는 항목임 * 매우중요







views.py

- dbtest/views.py 맨 밑에 내용 추가

```python
def update_form(request, id):
    return render((request, 'update.html', {'dto': MyBoard.objects.get(id=id)}))

def update_proc(request):
    mytitle = request.POST['mytitle']
    mycontent = request.POST['mycontent']
    id = request.POST['id']

    myboard = MyBoard.objects.filter(id=id)
    result_title = myboard.update(mytitle=mytitle)
    result_content = myboard.update(mycontent=mycontent)

    if result_title + result_content == 2:
        return redirect('/detail/' + id)
    else:
        return redirect('/updateform/' + id)
```

- result_title 과 result_content 에서 update 함수 뭘 리턴하는 지 ? 공부 

- redirect
  https://docs.djangoproject.com/en/4.0/topics/http/shortcuts/
  - 글수정 버튼을 누르면 localhost:8000/updateform/1 에서 
    updateform/updateres 로 클라이언트에게 전될되어야 하지만 redirect로 
    다시 서버로 돌아가게 해주기 때문에  localhost:8000/detail 로 돌아가게 됨 



urls.py

- dbtest/urls.py 내용 수정 

```python
urlpatterns = [
    path('admin/', admin.site.urls),
    path('', views.index, name='index'),
    path('detail/<int:id>', views.detail, name='detail'),
    path('insertform/', views.insert_form, name='insertform'),
    path('insertres/', views.insert_proc, name='insertres'),
    path('updateform/<int:id>', views.update_form, name='updateform'), # 내용 추가
    path('updateres/', views.update_proc), # 내용 추가
]
```



detail.html

- tamplates/detail.html 내용 수정

```html
<tr>
	<td colspan="2" align="right">
		<input type="button" onclick="" value="목록">
		<input type="button" onclick="location.href= '/updateform/{{ dto.id }}'" value="수정"> <!-- onclick 내용 추가 -->
		<input type="button" onclick="" value="삭제">
</td>
</tr>
```



update.html 

- templates/update.html
- form 의 action 옵션에 내용 추가 

```html
<form action="/updateres/" mathod="post">{% csrf_token %}
```



글수정 클릭 잘되는지 확인

```terminal
>python manage.py runserver
```



------

**삭제 버튼 화설화**



veiws.py

- dbtest/views.py
- 맨 밑에 내용 추가 

```python
def delete_proc(request, id):
    result_delete = MyBoard.objects.filter(id=id).delete()

    if result_delete[0]:
        return redirect('index')
    else:
        return redirect('/detail/' + id)
```



urls.py

- dbtest/urls.py

```python
urlpatterns = [
    path('admin/', admin.site.urls),
    path('', views.index, name='index'),
    path('detail/<int:id>', views.detail, name='detail'),
    path('insertform/', views.insert_form, name='insertform'),
    path('insertres/', views.insert_proc, name='insertres'),
    path('updateform/<int:id>', views.update_form, name='updateform'),
    path('updateres/', views.update_proc, name='updateres'),
    path('delete/<int:id>', views.delete_proc), ## 내용추가 
]
```



detail.html

- templates/detail.html 

```html
<tr>
    <td colspan="2" align="right">
        <input type="button" onclick="" value="목록">
        <input type="button" onclick="location.href= '/updateform/{{ dto.id }}'" value="수정">
        <input type="button" onclick="location.href= '/delete/{{ dto.id }}'" value="삭제">
    	<!-- 바로 위 input에 onclick 내용 추가  -->
    </td>
</tr>
```

